<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stream</title>
</head>
<body>
    <h1>Live Camera Stream</h1>
    
    <img id="video" src="" alt="Video stream not available">
    
    <script>
        let websocket = null;
        const videoElement = document.getElementById('video');
        let imageBuffer = [];
        const onCrashDelay = 3000;
        const websocketUrl = 'ws://192.168.0.124:8765';

        function webSocketsSetup(init) {
            if (websocket) {
                websocket.close(); 
                websocket.onclose = function() {
                    console.log('Previous WebSocket connection closed.');
                    setTimeout(init, onCrashDelay);
                };
            } else {
                setTimeout(init, onCrashDelay);
            }
        }
        const init = function () {
            websocket = new WebSocket(websocketUrl);
            websocket.binaryType = 'blob';
            websocket.onopen = function () {
                console.log('WebSocket connection established.');
            };
            websocket.onmessage = function(event) {
                imageBuffer.push(event.data);

                const blob = new Blob(imageBuffer, { type: 'image/jpeg' });
                const url = URL.createObjectURL(blob);
                
                document.getElementById('video').src = url;

                //setTimeout(() => URL.revokeObjectURL(url), 10000);
            };
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
            setInterval(() => {
                if (websocket.readyState === WebSocket.OPEN) {
                    websocket.send('ping'); 
                }
            }, 1000);
        }
        webSocketsSetup(init);
    </script>
</body>
</html>
