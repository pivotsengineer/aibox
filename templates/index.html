<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stream</title>
</head>
<body>
    <h1>Live Camera Stream</h1>
    
    <img id="video" src="" alt="Video stream not available">
    
    <script>
        let websocket = null;
        const videoElement = document.getElementById('video');
        const onCrashDelay = 2000;
        const websocketUrl = 'ws://192.168.0.124:8765';
        const webSocketsSetup = function () {
            if (websocket) {
                websocket.close(); 
                websocket.onclose = function() {
                    console.log('Previous WebSocket connection closed.');
                    setTimeout(init, onCrashDelay);
                };
                websocket.onopen = function () {
                    console.log('WebSocket connection established.');
                };
            } else {
                setTimeout(init, onCrashDelay);
            }
        }
        const init = function () {
            let imageBuffer = [];
            websocket = new WebSocket(websocketUrl);
            websocket.binaryType = 'blob';
            websocket.onmessage = function(event) {
                if(event.data  instanceof Blob) {
                    imageBuffer.push(event.data);
                    const blob = new Blob(imageBuffer, { type: 'image/jpeg' });
                    const url = URL.createObjectURL(blob);
                    const videoUrlTimout = setTimeout(() => videoElement.src = url, 500);
                    const revokeObjectURLTimout = setTimeout(() => URL.revokeObjectURL(url), 1000);
                }
            };
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
            setInterval(() => {
                if (websocket.readyState === WebSocket.OPEN) {
                    websocket.send('wake up!'); 
                }
            }, 1000);
        }
        webSocketsSetup();
    </script>
</body>
</html>
