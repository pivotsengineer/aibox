<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stream</title>
</head>
<body>
    <h1>Live Camera Stream</h1>
    <img id="video" src="" alt="Video stream not available">
    
    <script>
        const videoElement = document.getElementById('video');
        const websocket = new WebSocket('ws://192.168.0.124:8765');  // Adjust the WebSocket URL if needed
        let currentObjectURL = null;

        websocket.binaryType = 'blob';  // Ensure binary data is treated as Blob

        websocket.onmessage = function(event) {
            if (event.data instanceof Blob) {
                // Create a Blob URL and set it to the img element
                const url = URL.createObjectURL(event.data);
                videoElement.src = url;

                // Wait for the image to load before revoking the previous URL
                videoElement.onload = function() {
                    if (currentObjectURL) {
                        URL.revokeObjectURL(currentObjectURL);
                    }
                    currentObjectURL = url;
                };

                // Set a fallback to revoke the URL after a delay to handle any issues with onload
                setTimeout(() => {
                    if (currentObjectURL) {
                        URL.revokeObjectURL(currentObjectURL);
                        websocket.send('ACK');
                    }
                }, 0);  // Adjust the timeout as needed
            } else {
                console.error('Received non-Blob data:', event.data);
            }
        };

        websocket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        websocket.onclose = function() {
            console.log('WebSocket connection closed');
        };
    </script>
</body>
</html>
